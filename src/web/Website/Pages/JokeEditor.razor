@page "/jokeeditor"
@attribute [Authorize(Roles = "Admin")]
@using MudBlazor
<PageTitle>Joke Editor</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Joke Editor</MudText>
        <MudText Typo="Typo.body1" Class="mb-4">Manage and edit jokes in the database.</MudText>

        @if (isLoading)
        {
            <div class="d-flex flex-column align-center my-5">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body2" Class="mt-2">Loading jokes...</MudText>
            </div>
        }
        else if (editingJoke != null)
        {
            <!-- Edit Form -->
            <MudPaper Elevation="1" Class="pa-4">
                <MudText Typo="Typo.h5" Class="mb-4">Edit Joke #@editingJoke.JokeId</MudText>
                
                <MudTextField @bind-Value="editingJoke.JokeTxt" 
                              Label="Joke Text" 
                              Variant="Variant.Outlined" 
                              Lines="4" 
                              Class="mb-4" />

                <MudTextField @bind-Value="editingJoke.Attribution" 
                              Label="Attribution" 
                              Variant="Variant.Outlined" 
                              Class="mb-4" />

                <MudTextField @bind-Value="editingJoke.ImageTxt" 
                              Label="Image Description" 
                              Variant="Variant.Outlined" 
                              Lines="2" 
                              Class="mb-4" />

                <MudText Typo="Typo.subtitle1" Class="mb-2">Categories</MudText>
                <MudPaper Class="pa-3 mb-4" Outlined="true">
                    @foreach (var category in allCategories)
                    {
                        <MudCheckBox Value="@GetCategoryChecked(category.JokeCategoryId)"
                                     ValueChanged="@((bool val) => ToggleCategoryMud(category.JokeCategoryId, val))"
                                     Label="@category.JokeCategoryTxt" 
                                     Color="Color.Primary" />
                    }
                </MudPaper>

                <MudSelect @bind-Value="editingJoke.ActiveInd" 
                           Label="Active" 
                           Variant="Variant.Outlined" 
                           Class="mb-4">
                    <MudSelectItem Value="@("Y")">Yes</MudSelectItem>
                    <MudSelectItem Value="@("N")">No</MudSelectItem>
                </MudSelect>

                <MudStack Row="true" Spacing="2" Class="mb-3">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               OnClick="SaveJoke" 
                               Disabled="@isSaving">
                        @if (isSaving)
                        {
                            <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                        }
                        Save Changes
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Secondary" 
                               OnClick="CancelEdit" 
                               Disabled="@isSaving">
                        Cancel
                    </MudButton>
                </MudStack>

                @if (!string.IsNullOrEmpty(editMessage))
                {
                    <MudAlert Severity="@GetAlertSeverity()" Class="mt-3">@editMessage</MudAlert>
                }
            </MudPaper>
        }
        else
        {
            <!-- List View -->
            <MudStack Spacing="3" Class="mb-4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="searchText" 
                                      Label="Search" 
                                      Placeholder="Search jokes..." 
                                      Variant="Variant.Outlined"
                                      Immediate="true"
                                      DebounceInterval="300"
                                      OnDebounceIntervalElapsed="FilterJokes"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSelect Value="categoryFilter" 
                                   Label="Category" 
                                   Variant="Variant.Outlined"
                                   ValueChanged="@((string val) => { categoryFilter = val; FilterJokes(); })">
                            <MudSelectItem Value="@("")">All Categories</MudSelectItem>
                            @foreach (var category in allCategories)
                            {
                                <MudSelectItem Value="@category.JokeCategoryTxt">@category.JokeCategoryTxt</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                </MudGrid>
            </MudStack>

            <MudDataGrid T="Joke" 
                         Items="@filteredJokes" 
                         Striped="true" 
                         Hover="true"
                         SortMode="SortMode.Multiple"
                         Filterable="false"
                         Dense="true"
                         Class="mb-4">
                <Columns>
                    <PropertyColumn Property="x => x.JokeId" Title="ID" />
                    <TemplateColumn Title="Joke" Sortable="true" SortBy="@_sortByJokeText">
                        <CellTemplate>
                            <MudText Typo="Typo.body2">
                                @(context.Item.JokeTxt != null ? (context.Item.JokeTxt.Length > 100 ? context.Item.JokeTxt.Substring(0, 100) + "..." : context.Item.JokeTxt) : "")
                            </MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Categories" Title="Categories" />
                    <PropertyColumn Property="x => x.ActiveInd" Title="Active" />
                    <TemplateColumn Title="Actions" Sortable="false">
                        <CellTemplate>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       Size="Size.Small" 
                                       StartIcon="@Icons.Material.Filled.Edit"
                                       OnClick="@(() => EditJoke(context.Item.JokeId))">
                                Edit
                            </MudButton>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="Joke" />
                </PagerContent>
            </MudDataGrid>

            <MudText Typo="Typo.body2">
                Total Jokes: @(filteredJokes?.Count() ?? 0) of @(allJokes?.Count() ?? 0)
            </MudText>
        }
    </MudPaper>
</MudContainer>

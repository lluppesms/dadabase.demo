# ------------------------------------------------------------------------------------------------------------------------
# Pipeline template to run one SQL Script against an existing database
# See https://learn.microsoft.com/en-us/azure/devops/pipelines/targets/azure-sqldb?view=azure-devops&tabs=yaml
# ----------------------------------------------------------------------------------------------------
# Unless you are using a local user/password, you must find the service principal name that is running
# your pipeline and execute these commands in the Azure SQL Database to grant access:
#   CREATE USER yourSP FROM EXTERNAL PROVIDER
#   ALTER ROLE db_owner ADD MEMBER yourSP
# See also https://learn.microsoft.com/en-us/azure/azure-sql/database/authentication-aad-configure
# ------------------------------------------------------------------------------------------------------------------------
parameters: 
- name: environmentName
  default:  'DEV'
- name: sqlFolderName
  default: ''
- name: sqlFileName
  default: ''
- name: runInDatabase
  default: ''
- name: loginAccountType
  default: 'SVC_PRINCIPAL'
- name: resourceGroupName
  default: ''
- name: databaseCopyName
  default: ''

# ------------------------------------------------------------------------------------------------------------------------
jobs:
- deployment: Deploy${{ parameters.environmentName }}SQL
  displayName: Initialize ${{ parameters.environmentName }} Deploy SQL
  environment: ${{ parameters.environmentName }}

- job: DeployDB${{ parameters.environmentName }}SQL
  displayName: Deploy ${{ parameters.environmentName }} SQL
  variables:
    - name: environmentNameUpper
      value: ${{ upper(parameters.environmentName) }}
    - name: environmentNameLower
      value: ${{ lower(parameters.environmentName) }}
    - name: sqlServerName
      value: $(SQL_SERVER_NAME_PREFIX)$(INSTANCE_NUMBER)sql${{ lower(parameters.environmentName) }}
    - name: fqdnServerName
      value: $(sqlServerName).database.windows.net
    - name: sqlFullFolderName
      value: $(System.DefaultWorkingDirectory)\${{ parameters.sqlFolderName }}
    - name: sqlFullFileName
      value: $(System.DefaultWorkingDirectory)\${{ parameters.sqlFolderName }}${{ parameters.sqlFileName }}


    - name: azDbCopyScriptFullName
      value: $(System.DefaultWorkingDirectory)\scripts\azDbCopyCommand.ps1

    - name: dummyOutputFile
      value: $(Build.ArtifactStagingDirectory)\Output\Sample-Output-1.txt

    # Bring in environment common variable file
    - template: ../../vars/var-service-connections.yml
    - template: ../../vars/var-common.yml
    
    # Bring in environment specific variable files
    - ${{ if eq(lower(parameters.environmentName), 'dev') }}:
      - template: ../../vars/var-dev.yml
    - ${{ if eq(lower(parameters.environmentName), 'qa') }}:
      - template: ../../vars/var-qa.yml
    - ${{ if eq(lower(parameters.environmentName), 'prod') }}:
      - template: ../../vars/var-prod.yml

  steps:
  - bash: |
      runDateTime=$(echo $(date '+%Y%m%d%H%M'))
      echo "##vso[task.setvariable variable=runDateTime]$runDateTime"
      echo "runDateTime=$runDateTime"
                                  
      logFullFileName=$(echo "$(Build.ArtifactStagingDirectory)\Output\${{ parameters.sqlFileName }}.$runDateTime.log")
      echo "##vso[task.setvariable variable=logFullFileName]$logFullFileName"
      echo "logFullFileName=$logFullFileName"
    displayName: 'Create Variables'
    continueOnError: true

  - task: PowerShell@2
    displayName: Make Output Folder
    inputs:
      targetType: 'inline'
      script: |
        cd $(Build.ArtifactStagingDirectory)
        md Output
        cd Output
        echo "Sample file so that publish command won't fail..." > $(exampleOutputFile)
        cd ..
      errorActionPreference: 'continue'
      failOnStderr: false

  - bash: |
      echo "resourceGroupName=${{ parameters.resourceGroupName }}"
      echo "serviceConnectionDEV=$(serviceConnectionDEV)"
      echo "serviceConnectionQA=$(serviceConnectionQA)"
      echo "serviceConnectionPROD=$(serviceConnectionPROD)"
      echo "sqlServerName=$(sqlServerName)"
      echo "fqdnServerName=$(fqdnServerName)"
      echo "runInDatabase=${{ parameters.runInDatabase }}"
      echo "DatabaseToCopy=${{ parameters.runInDatabase }}"
      echo "sqlFullFileName=$(sqlFullFileName)"
      echo "logFullFileName=$(logFullFileName)"
      echo "logFullFileName=$(logFullFileName)"
      echo "invokeSQLScriptFullName=$(invokeSQLScriptFullName)"
      echo "azDbCopyScriptFullName=$(azDbCopyScriptFullName)"
      echo "CMD: Sqlcmd -i $(sqlFullFileName) -S $(fqdnServerName) -d ${{ parameters.runInDatabase }} -U $(SQLADMIN_LOGIN_USERID) -P $(sqlAdminPassword) -o $(logFullFileName)"
      echo "PS: Invoke-SqlCmd -ServerInstance '$(fqdnServerName)' -Database '${{ parameters.runInDatabase }}' -AccessToken 'xxxxx' -InputFile '$(sqlFullFileName)' -Verbose | Out-File -FilePath $(logFullFileName)"
    displayName: 'Display variables and CMD'
    continueOnError: true

  - task: CmdLine@2
    displayName: 'List Input Files'
    inputs:
      script: |
        echo "SQL File: $(sqlFullFileName)"
        echo "Directory of $(sqlFullFolderName)"
        dir $(sqlFullFolderName) /s
    continueOnError: true

  # ------------------------------------------------------------------------------------------------------------------------
  # Run SQL Commands (excluding DBCOPY operations)
  # ------------------------------------------------------------------------------------------------------------------------
  - ${{ if ne(lower(parameters.sqlFileName), 'DBCOPY') }}:
    - ${{ if eq(variables.environmentNameUpper, 'DEV') }}:
      - template: steps-run-sql-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionDEV }}
          loginAccountType: ${{ parameters.loginAccountType }}
          runInDatabase: ${{ parameters.runInDatabase }}
          sqlFullFileName: $(sqlFullFileName)
          fqdnServerName: $(fqdnServerName)
          logFullFileName: $(logFullFileName)
          sqlAdminUser: $(sqlAdminUser)
          sqlAdminPassword: $(sqlAdminPassword)
    - ${{ if eq(variables.environmentNameUpper, 'QA') }}:
      - template: steps-run-sql-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionQA }}
          loginAccountType: ${{ parameters.loginAccountType }}
          runInDatabase: ${{ parameters.runInDatabase }}
          sqlFullFileName: $(sqlFullFileName)
          fqdnServerName: $(fqdnServerName)
          logFullFileName: $(logFullFileName)
          sqlAdminUser: $(sqlAdminUser)
          sqlAdminPassword: $(sqlAdminPassword)
    - ${{ if eq(variables.environmentNameUpper, 'PROD') }}:
      - template: steps-run-sql-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionPROD }}
          loginAccountType: ${{ parameters.loginAccountType }}
          runInDatabase: ${{ parameters.runInDatabase }}
          sqlFullFileName: $(sqlFullFileName)
          fqdnServerName: $(fqdnServerName)
          logFullFileName: $(logFullFileName)
          sqlAdminUser: $(sqlAdminUser)
          sqlAdminPassword: $(sqlAdminPassword)

  # ------------------------------------------------------------------------------------------------------------------------
  # Run AzSqlDatabaseCopy command in Pipeline Service Connection context
  # ------------------------------------------------------------------------------------------------------------------------
  - ${{ if eq(lower(parameters.sqlFileName), 'DBCOPY') }}:
    - ${{ if eq(variables.environmentNameUpper, 'DEV') }}:
      - template: steps-run-dbcopy-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionDEV }}
          loginAccountType: ${{ parameters.loginAccountType }}
          sqlFileName: ${{ parameters.sqlFileName }}
          resourceGroupName: ${{ parameters.resourceGroupName }}
          runInDatabase: ${{ parameters.runInDatabase }}
          databaseCopyName: ${{ parameters.databaseCopyName }}
          azDbCopyScriptFullName: $(azDbCopyScriptFullName)
          sqlServerName: $(sqlServerName)
          logFullFileName: $(logFullFileName)
    - ${{ if eq(variables.environmentNameUpper, 'QA') }}:
      - template: steps-run-dbcopy-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionQA }}
          loginAccountType: ${{ parameters.loginAccountType }}
          sqlFileName: ${{ parameters.sqlFileName }}
          resourceGroupName: ${{ parameters.resourceGroupName }}
          runInDatabase: ${{ parameters.runInDatabase }}
          databaseCopyName: ${{ parameters.databaseCopyName }}
          azDbCopyScriptFullName: $(azDbCopyScriptFullName)
          sqlServerName: $(sqlServerName)
          logFullFileName: $(logFullFileName)
    - ${{ if eq(variables.environmentNameUpper, 'PROD') }}:
      - template: steps-run-dbcopy-template.yml
        parameters:
          serviceConnectionName: ${{ variables.serviceConnectionPROD }}
          loginAccountType: ${{ parameters.loginAccountType }}
          sqlFileName: ${{ parameters.sqlFileName }}
          resourceGroupName: ${{ parameters.resourceGroupName }}
          runInDatabase: ${{ parameters.runInDatabase }}
          databaseCopyName: ${{ parameters.databaseCopyName }}
          azDbCopyScriptFullName: $(azDbCopyScriptFullName)
          sqlServerName: $(sqlServerName)
          logFullFileName: $(logFullFileName)

  # ------------------------------------------------------------------------------------------------------------------------
  # Publish output and artifacts
  # ------------------------------------------------------------------------------------------------------------------------
  - task: CmdLine@2
    displayName: 'List Output Files'
    inputs:
      script: |
        echo "Directory of Staging Directory: $(Build.ArtifactStagingDirectory)"
        dir $(Build.ArtifactStagingDirectory) /s
        echo "Directory of Temp Directory: D:\a\_temp\"
        dir D:\a\_temp\ /s
    continueOnError: true

  - ${{ if ne(lower(parameters.sqlFileName), 'DBCOPY') }}:
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Input SQL Artifact'
      inputs:
        PathtoPublish: '$(sqlFullFileName)'
        ArtifactName: 'Input'
      continueOnError: true

  - ${{ if eq(lower(parameters.sqlFileName), 'DBCOPY') }}:
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Input DBCopy Artifact'
      inputs:
        PathtoPublish: '$(azDbCopyScriptFullName)'
        ArtifactName: 'Input'
      continueOnError: true
      
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Output Artifacts'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\Output'
      ArtifactName: 'Output'
    continueOnError: true

@* NinetiesThemeDecorations.razor: 90's themed decorations including under construction banner, flames, and hit counter *@
@using Microsoft.JSInterop
@namespace DadABase.Web.Shared
@inject IJSRuntime JS
@inject DadABase.Web.Repositories.ThemeService ThemeService
@implements IDisposable

@if (isNinetiesTheme)
{
    <div class="nineties-decorations">
        <!-- Hit Counter and Badges Row -->
        <div style="text-align: center; padding: 0 20px 20px 20px; background: #000000; border: 3px solid #ffff00; margin-top: 10px;">
            <div style="display: flex; align-items: center; justify-content: center; margin-top: 15px;">
                <span class="spinning-logo" style="font-size: 2rem; margin: 0 10px;">üåü</span>
                <span class="spinning-logo" style="font-size: 2rem; margin: 0 10px; animation-delay: 0.5s;">üí´</span>
                <div class="hit-counter" style="margin: 0 15px;">
                    üëÅÔ∏è VISITORS: <span>@hitCount.ToString("D6")</span> üëÅÔ∏è
                </div>
                <span class="spinning-logo" style="font-size: 2rem; margin: 0 10px; animation-delay: 1s;">‚ú®</span>
                <span class="spinning-logo" style="font-size: 2rem; margin: 0 10px; animation-delay: 1.5s;">‚≠ê</span>
            </div>
            <div style="margin-top: 10px;">
                <a href="https://archive.org/details/netscape-navigator-4.0.4" target="_blank" style="display: inline-block; height: 31px; margin: 5px; background: linear-gradient(90deg, #ff00ff, #00ffff); padding: 5px 10px; border: 2px solid #ffff00; font-size: 11px; color: #000; font-weight: bold; text-decoration: none;">
                    <span style="animation: blink 1s linear infinite;">‚ö°</span> BEST VIEWED IN NETSCAPE NAVIGATOR 4.0 <span style="animation: blink 1s linear infinite;">‚ö°</span>
                </a>
                <a href="https://archive.org/details/ie4.0" target="_blank" style="display: inline-block; height: 31px; margin: 5px; background: linear-gradient(90deg, #00ffff, #ffff00); padding: 5px 10px; border: 2px solid #ff00ff; font-size: 11px; color: #000; font-weight: bold; text-decoration: none;">
                    <span style="animation: blink 1s linear infinite;">üíª</span> DOWNLOAD INTERNET EXPLORER NOW! <span style="animation: blink 1s linear infinite;">üíª</span>
                </a>
            </div>
            <div style="margin-top: 10px; font-size: 10px;">
                <span style="animation: blink 1.5s linear infinite; color: #00ff00 !important;">‚òÖ</span>
                <span style="color: #00ff00 !important; text-shadow: 0 0 5px #00ff00;">This site is OPTIMIZED for 800x600 resolution!</span>
                <span style="animation: blink 1.5s linear infinite; color: #00ff00 !important;">‚òÖ</span>
            </div>
        </div>
    </div>
}

@code {
    private bool isNinetiesTheme = false;
    private int hitCount = 0;
    private const string HitCountKey = "nineties-hit-count";
    private const string ThemeKey = "theme-mode";

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += HandleThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if 90's theme is active
            var theme = await JS.InvokeAsync<string>("localStorage.getItem", ThemeKey);
            isNinetiesTheme = theme == "nineties";

            if (isNinetiesTheme)
            {
                await IncrementHitCounter();
                StateHasChanged();
            }
        }
    }

    private async void HandleThemeChanged()
    {
        await UpdateThemeStatus();
    }

    // Method to be called when theme changes (can be invoked from parent)
    public async Task UpdateThemeStatus()
    {
        var theme = await JS.InvokeAsync<string>("localStorage.getItem", ThemeKey);
        var wasNineties = isNinetiesTheme;
        isNinetiesTheme = theme == "nineties";

        if (isNinetiesTheme && !wasNineties)
        {
            await IncrementHitCounter();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task IncrementHitCounter()
    {
        // Get or initialize hit counter
        var countStr = await JS.InvokeAsync<string>("localStorage.getItem", HitCountKey);
        if (int.TryParse(countStr, out var count))
        {
            hitCount = count + 1;
        }
        else
        {
            hitCount = 1337; // Start with a cool 90's number
        }

        // Save updated count
        await JS.InvokeVoidAsync("localStorage.setItem", HitCountKey, hitCount.ToString());
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }
}

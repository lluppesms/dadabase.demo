@page "/"
@namespace DadABase.Web.Pages
@using MudBlazor

<PageTitle>@Data.Constants.ApplicationTitle</PageTitle>

<div class="page-container">
    <MudContainer MaxWidth="MaxWidth.Large">
        <h1>Tell me a Joke, Dad!</h1>
        @if (jokeLoading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <div class="joke-container">
                <ul id="jokeList" style="list-style-type: none; padding: 0;">
                  <li><JokeDisplayComponent myJoke="@myJoke" /></li>
                </ul>
            </div>
        }
            <div class="button-group">
                <button class="btn btn-primary" @onclick="ExecuteRandom">Tell me another one!</button>

                @if (imageDescriptionGenerated && showButtons)
                {
                    <button class="btn btn-primary" @onclick="CreatePicture">Paint me a picture!</button>
                }
            </div>
            <div class="ai-toggle">
                <MudSwitch T="bool"
                        @bind-Value="@aiFeaturesEnabled"
                        Color="Color.Secondary"
                        Label="AI features"
                        Class="ai-switch" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="@(async () => await GenerateAIDescription())" Disabled="@(!aiFeaturesEnabled || imageDescriptionGenerated || imageLoading)">Generate Description</MudButton>
                <p class="ai-hint">Off by default to avoid AI calls until requested.</p>
            </div>
            <div class="joke-image-section">
                <p class="image-message">@jokeImageMessage</p>
                @if (imageGenerating)
                {
                    <p class="image-note">@jokeImageDescription</p>
                }
                @if (imageLoading)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                }
                else
                {
                    @if (!string.IsNullOrEmpty(jokeImageUrl)) {
                      <img src="@jokeImageUrl" class="joke-image" width="400" style="cursor: pointer;" @onclick="ShowImageDescriptionPopup" />
                    }
                    else if (!string.IsNullOrEmpty(jokeImageDescription))
                    {
                        <p class="image-note">@jokeImageDescription</p>
                    }
                }
            </div>
        <MudDialog @bind-Visible="@imageDescriptionDialogVisible">
            <TitleContent>
                <MudText Typo="Typo.h6">Image Description</MudText>
            </TitleContent>
            <DialogContent>
                <p>@jokeImageDescription</p>
            </DialogContent>
            <DialogActions>
                <MudButton Color="Color.Secondary" OnClick="@CloseImageDescriptionPopup">Close</MudButton>
            </DialogActions>
        </MudDialog>



            @if (jokeHistory.Any())
            {
                <div class="history-section">
                    <h5 class="history-toggle"
                        tabindex="0"
                        @onclick="ToggleHistory"
                        @onkeydown="@(e => { if (e.Key == "Enter" || e.Key == " ") ToggleHistory(); })">
                        Joke History
                        <span style="margin-left: 8px; font-size: 1.2em;">
                            @(isHistoryCollapsed ? "👁️" : "🙈")
                        </span>
                    </h5>
                    @if (!isHistoryCollapsed)
                    {
                        <ul style="list-style-type: none; padding: 0;">
                            @foreach (var joke in jokeHistory)
                            {
                                <li><JokeDisplayComponent myJoke="@joke" /></li>
                            }
                        </ul>
                    }
                </div>
            }
    </MudContainer>
</div>
